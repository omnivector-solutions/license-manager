FROM ubuntu:resolute

# Install GOSU
ARG GOSU_VERSION=1.16

RUN set -ex \
    && apt update \
    && apt install wget gpg -y \
    && wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-amd64" \
    && wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-amd64.asc" \
    && export GNUPGHOME="$(mktemp -d)" \
    && gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4 \
    && gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu \
    && rm -rf "${GNUPGHOME}" /usr/local/bin/gosu.asc \
    && chmod +x /usr/local/bin/gosu \
    && gosu nobody true


# Install slurm from slurm-factory binary cache
RUN set -ex \
    && mkdir -p /opt/slurm \
    && wget -qO- https://slurm-factory-spack-binary-cache.vantagecompute.ai/resolute/25.11/slurm-25.11-resolute-software.tar.gz | tar --no-same-owner --no-same-permissions --touch -xz -C /opt/slurm \
    && apt update \
    && apt install -y mysql-client python3 \
    && rm -rf /var/lib/apt/lists/*

# Add slurm binaries to PATH and create slurm user/group
ENV PATH="/opt/slurm/view/bin:/opt/slurm/view/sbin:${PATH}"
ENV LD_LIBRARY_PATH="/opt/slurm/view/lib/private:/opt/slurm/view/lib:/opt/slurm/view/lib/slurm:${LD_LIBRARY_PATH}"

RUN groupadd -r slurm && useradd -r -g slurm slurm \
    && groupadd -r slurmrestd && useradd -r -g slurmrestd slurmrestd

ENV PATH=/usr/local/bin:$PATH

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Prepare Filesystem
RUN mkdir /var/spool/slurmctld \
    && mkdir /var/spool/slurmd

COPY etc/slurm-config/slurmdbd.conf /etc/slurm/slurmdbd.conf
COPY etc/slurm-config/slurm.conf /etc/slurm/slurm.conf
COPY etc/slurm-config/cgroup.conf /etc/slurm/cgroup.conf
COPY etc/slurm-config/slurm-env.sh /etc/profile.d/slurm-env.sh

ARG JWT_SECRET=supersecret
RUN echo -n "$JWT_SECRET" > /etc/slurm/jwt_hs256.key

# Generate slurm.key for auth/slurm authentication
RUN dd if=/dev/urandom bs=1 count=1024 > /etc/slurm/slurm.key

RUN chown -R slurm:slurm /var/spool/slurmctld \
    && chmod 640 /etc/slurm/jwt_hs256.key \
    && chown slurm:slurmrestd /etc/slurm/jwt_hs256.key \
    && chmod 600 /etc/slurm/slurm.key \
    && chmod 600 /etc/slurm/slurmdbd.conf \
    && chown -R slurm:slurm /var/spool/slurmd \
    && chown -R slurm:slurm /etc/slurm

RUN mkdir -p /var/log/license-manager-agent \
    && mkdir -p /var/cache/license-manager-agent \
    && mkdir -p /var/log/slurm \
    && mkdir -p /var/run \
    && chown -R slurm:slurm /var/log/license-manager-agent \
    && chown -R slurm:slurm /var/cache/license-manager-agent \
    && chown -R slurm:slurm /var/log/slurm \
    && chmod -R 777 /var/log/license-manager-agent \
    && chmod -R 777 /var/cache/license-manager-agent \
    && chmod -R 777 /var/log/slurm \
    && chmod 777 /var/run

# Create symlink for slurmstepd at the spack placeholder path
RUN mkdir -p /opt/slurm/software/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder___/slurm-25-11-1-1-7otctkr/sbin \
    && ln -s /opt/slurm/view/sbin/slurmstepd /opt/slurm/software/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder___/slurm-25-11-1-1-7otctkr/sbin/slurmstepd

# Copy in the entrypoint.sh
COPY etc/slurm-config/slurm-entrypoint.sh /usr/local/bin/slurm-entrypoint.sh

ENTRYPOINT ["/usr/local/bin/slurm-entrypoint.sh"]
