name: Publish on Tag

# This action:
#   - Is triggered when a new version is tagged;
#   - Check if the version for each sub-project matches the tag;
#   - Build and release the packages to PyPI.
#   - Build the agent snap and upload to the snap store.
#   - Build the License Manager API Docker image and push to ECR.
#   - Build the License Manager Agent Docker image and push to GHCR.

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+-alpha.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+a[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+b[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+rc[0-9]+'

permissions:
  contents: read
  packages: write

jobs:
  build-publish:
    runs-on: ubuntu-latest
    strategy:
      matrix: { sub_project: ['lm-agent', 'lm-api', 'lm-cli', 'lm-simulator', 'lm-simulator-api'] }
      fail-fast: false
    outputs:
      agent-pypi-version: ${{ steps.extract-metadata.outputs.version }}
      agent-pypi-package-name: ${{ steps.extract-metadata.outputs.name }}
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: 3.12
  
      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7

      - id: uv-package-version
        name: Get project's version
        working-directory: ${{ matrix.sub_project }}
        run: |
          echo "uv version is: $(uv version --short)"
          echo "::set-output name=version::$(uv version --short)"

      - name: Fail if package version doesn't match the tag
        if: ${{ github.ref_name != steps.uv-package-version.outputs.version }}
        run: |
          echo "uv package version doesn't match tag!"
          echo "tag=${{ github.ref_name }}, version=${{ steps.uv-package-version.outputs.version }}"
          exit 1

      - name: Build and publish on PyPI
        working-directory: ${{ matrix.sub_project }}
        env:
          UV_PYPI_TOKEN: ${{ secrets.OMNIVECTOR_PYPI_TOKEN }}
        run: |
          uv build
          uv publish

      - name: Output metadata
        working-directory: ${{ matrix.sub_project }}
        if: matrix.sub_project == 'lm-agent'
        id: extract-metadata
        run: |
          echo "version=$(uv version --short)" >> "$GITHUB_OUTPUT"
          echo "name=$(uv version | awk '{print $1}')" >> "$GITHUB_OUTPUT"

  publish-to-ecr:
    name: Publish to ECR
    runs-on: ubuntu-latest
    steps:

      - name: Fail if ref is not a tag
        if: github.ref_type != 'tag'
        run: |
          echo "Publish only supported from tag refs!"
          echo "Got ref_type=${{ github.ref_type }} instead"
          exit 1

      - uses: actions/checkout@v3

      - uses: actions/setup-python@v3
        with:
          python-version: 3.12

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7

      - id: uv-package-version
        name: Get version of project from uv
        working-directory: lm-api
        run: |
          echo "uv version is: $(uv version --short)"
          echo "::set-output name=version::$(uv version --short)"

      - name: Fail if uv package version doesn't match tag
        if: ${{ github.ref_name != steps.uv-package-version.outputs.version }}
        run: |
          echo "uv package version doesn't match tag!"
          echo "tag=${{ github.ref_name }}, version=${{ steps.uv-package-version.outputs.version }}"
          exit 1

      - name: Setup AWS credentials
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1
        with:
          aws-access-key-id    : ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}
          aws-region           : ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          IMAGE_TAG=${{ github.ref_name }}
          docker build -t $ECR_REGISTRY/${{ vars.ECR_REPOSITORY }}:$IMAGE_TAG lm-api
          docker push $ECR_REGISTRY/${{ vars.ECR_REPOSITORY }}:$IMAGE_TAG

  publish-agent-to-ghcr:
    name: Publish Agent to GHCR
    runs-on: ubuntu-latest
    steps:

      - name: Fail if ref is not a tag
        if: github.ref_type != 'tag'
        run: |
          echo "Publish only supported from tag refs!"
          echo "Got ref_type=${{ github.ref_type }} instead"
          exit 1

      - uses: actions/checkout@v3

      - uses: actions/setup-python@v3
        with:
          python-version: 3.12

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7

      - id: uv-package-version
        name: Get version of project from uv
        working-directory: lm-agent
        run: |
          echo "uv version is: $(uv version --short)"
          echo "::set-output name=version::$(uv version --short)"

      - name: Fail if uv package version doesn't match tag
        if: ${{ github.ref_name != steps.uv-package-version.outputs.version }}
        run: |
          echo "uv package version doesn't match tag!"
          echo "tag=${{ github.ref_name }}, version=${{ steps.uv-package-version.outputs.version }}"
          exit 1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/lm-agent
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./lm-agent/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  snapstore:
    runs-on: ubuntu-24.04
    needs: [build-publish]
    env:
      SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Snapcraft
        uses: samuelmeuli/action-snapcraft@75db9a03f97072c02648bf8339bd4ac678fe2607 #v2

      - name: Install Jq
        run: sudo snap install jq --channel latest/stable

      - name: Wait latest version on PyPI
        env:
          DESIRED_VERSION: ${{ needs.build-publish.outputs.agent-pypi-version }}
          PACKAGE_NAME: ${{ needs.build-publish.outputs.agent-pypi-package-name }}
        timeout-minutes: 1
        run: |
          while true; do
            echo "Checking for version $DESIRED_VERSION of $PACKAGE_NAME"
            curl -s https://pypi.org/pypi/$PACKAGE_NAME/json | jq -r '.releases | keys[]' | grep -q $DESIRED_VERSION
            if [ $? -eq 0 ]; then
              echo "Version $DESIRED_VERSION is available"
              break
            else
              echo "Version $DESIRED_VERSION is not available yet"
              sleep 2
            fi
          done

      - name: Install core24
        run: sudo snap install core24 --channel latest/stable

      - name: Set up LXD
        uses: canonical/setup-lxd@a3c85fc6fb7fff43fcfeae87659e41a8f635b7dd # v0.1.3
        with:
          channel: 5.21/stable

      - name: Build snap
        id: build
        working-directory: ./lm-agent-snap
        run: |
          make build ARGS="-v"
          SNAP_FILE_PATH=`find . -name '*.snap'`
          echo "snap_file_path=$SNAP_FILE_PATH" >> "$GITHUB_OUTPUT"

      - name: Release to Edge
        working-directory: ./lm-agent-snap
        run: |
          snapcraft upload --release latest/edge,latest/candidate ${{ steps.build.outputs.snap_file_path }}

      - name: Archive snap logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: upload-snap-log
          path: /home/runner/.local/state/snapcraft/log/**
