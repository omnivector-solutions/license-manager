name: Prepare for release

# This action:
#   - Is triggered manually in a workflow dispatch;
#   - Inquire the kind of base and stage release in a dropdown menu;
#   - Use uv to bump up the versions;
#   - Create a new header for the new version at the changelogs;
#   - Check if all sub-projects share the same version number;
#   - Create a new branch named prepare-release/<new_version>;
#   - Open a draft PR to the main branch, so all the changes above can be reviewed by the team before merging.

on:
  workflow_dispatch:
    inputs:
      base_bump:
        description: Base version bump
        type: choice
        required: false
        options:
          - ""
          - major
          - minor
          - patch
          - stable
      stage_bump:
        description: Prerelease / release stage
        type: choice
        required: false
        options:
          - ""
          - alpha
          - beta
          - rc
          - post
          - dev


permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        subproject:
          - lm-agent
          - lm-api
          - lm-cli
          - lm-simulator
          - lm-simulator-api

    outputs:
      version: ${{ steps.capture-version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.12

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7

      - name: Validate version bump inputs
        if: matrix.subproject == 'lm-agent'
        run: |
          BASE="${{ inputs.base_bump }}"
          STAGE="${{ inputs.stage_bump }}"

          if [ -z "$BASE" ] && [ -z "$STAGE" ]; then
            echo "Error: at least one of base_bump or stage_bump must be set"
            exit 1
          fi

          if [ "$BASE" = "stable" ] && [ -n "$STAGE" ]; then
            echo "Error: 'stable' must not be combined with stage_bump"
            exit 1
          fi

          if [ -z "$BASE" ] && [ -n "$STAGE" ]; then
            CURRENT_VERSION=$(uv version --short)
            if ! echo "$CURRENT_VERSION" | grep -Eq '(a|b|rc|dev|post)[0-9]+$'; then
              echo "Error: stage_bump without base_bump requires an existing prerelease"
              echo "Current version: $CURRENT_VERSION"
              exit 1
            fi
          fi

      - name: Bump version
        working-directory: ${{ matrix.subproject }}
        run: |
          if [ -n "${{ inputs.base_bump }}" ]; then
            uv version --bump "${{ inputs.base_bump }}"
          fi

          if [ -n "${{ inputs.stage_bump }}" ]; then
            uv version --bump "${{ inputs.stage_bump }}"
          fi

      - name: Capture version
        id: capture-version
        if: matrix.subproject == 'lm-agent'
        working-directory: lm-agent
        run: |
          VERSION=$(uv version --short)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify version consistency
        if: matrix.subproject != 'lm-agent'
        working-directory: ${{ matrix.subproject }}
        run: |
          EXPECTED="${{ needs.bump-version.outputs.version }}"
          CURRENT=$(uv version --short)

          if [ "$CURRENT" != "$EXPECTED" ]; then
            echo "Version mismatch in ${{ matrix.subproject }}"
            echo "Expected: $EXPECTED"
            echo "Found:    $CURRENT"
            exit 1
          fi

  create-pr:
    runs-on: ubuntu-latest
    needs: bump-version

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@4320041ed380b20e97d388d56a7fb4f9b8c20e79 # v7
        id: cpr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Prepared release ${{ needs.bump-version.outputs.version }}"
          branch: prepare-release/${{ needs.bump-version.outputs.version }}
          title: Release ${{ needs.bump-version.outputs.version }}
          draft: true
          delete-branch: true
          body: |
            Automated changes by [prepare_release](https://github.com/omnivector-solutions/license-manager/blob/main/.github/workflows/prepare_release.yaml) GitHub action.

      - name: Show Pull Request info
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
